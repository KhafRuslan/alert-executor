# Alert Executor API

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –Ω–∞ FastAPI –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤ –∏–∑ **Grafana Alerting** –∏–ª–∏ **Alertmanager**. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –º–µ—Ç–æ–∫ –∞–ª–µ—Ä—Ç–∞ (labels) –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã.

---

## üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ü—Ä–∏—ë–º –∞–ª–µ—Ä—Ç–æ–≤ –ø–æ HTTP-–∑–∞–ø—Ä–æ—Å—É (`POST /alert`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `alert_id` –∏–∑ —Å—Å—ã–ª–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (`generatorURL`)
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥, –∑–∞–¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
- **–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ç–æ–∫ –∞–ª–µ—Ä—Ç–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{instance}`, `{topic}`) –≤ –∫–æ–º–∞–Ω–¥—ã
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–∫ (–ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ñ–∞–π–ª –∏ –≤ stdout
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –∫–æ–º–∞–Ω–¥ (60 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
alert-executor/
‚îú‚îÄ‚îÄ main.py                 # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ alerts_config.yaml      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –ø–æ alert_id
‚îú‚îÄ‚îÄ alert_executor.log      # –õ–æ–≥-—Ñ–∞–π–ª (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îî‚îÄ‚îÄ README.md
```

---

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install fastapi uvicorn pyyaml
```

### 2. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª

–ü—Ä–∏–º–µ—Ä `alerts_config.yaml`:

```yaml
alert:
  - cf4dxqbfes7pcf:
      command:
        - echo "–ê–ª–µ—Ä—Ç –Ω–∞ —Ö–æ—Å—Ç–µ {instance}, —Ç–æ–ø–∏–∫: {topic}"
        - /opt/scripts/handle_kafka_alert.sh --host {instance} --topic {topic}
  - another_alert_uid_123:
      command:
        - /usr/bin/notify-team.sh "{alertname}"
```

> ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ (—Å—Ç—Ä–æ–∫–∞), —Ç–∞–∫ –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å

```bash
python main.py
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://0.0.0.0:9999/alert`.

–î–ª—è production-–∑–∞–ø—É—Å–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `uvicorn` –Ω–∞–ø—Ä—è–º—É—é:

```bash
uvicorn main:app --host 0.0.0.0 --port 9999 --workers 2
```

---

## üì• –§–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ –∞–ª–µ—Ä—Ç–∞

–°–µ—Ä–≤–∏—Å –æ–∂–∏–¥–∞–µ—Ç JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ [Grafana Alerting webhook](https://grafana.com/docs/grafana/latest/alerting/notify/webhook/), –Ω–∞–ø—Ä–∏–º–µ—Ä:

```json
{
  "receiver": "webhook-alert-to-action",
  "status": "firing",
  "alerts": [
    {
      "status": "firing",
      "labels": {
        "alertname": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—ã—à–ª–∞ –∑–∞ –ø–æ—Ä–æ–≥ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è",
        "instance": "11log-kafka01",
        "topic": "docker"
      },
      "annotations": {},
      "generatorURL": "https://grafana-ib.loh.bz:443/alerting/grafana/cf4dxqbfes7pcf/..."
    }
  ]
}
```

> üîç **–í–∞–∂–Ω–æ**: `alert_id` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `generatorURL` –∫–∞–∫ —á–∞—Å—Ç—å –ø—É—Ç–∏ –ø–æ—Å–ª–µ `/grafana/`.  
> –ü—Ä–∏–º–µ—Ä: –∏–∑ `.../grafana/cf4dxqbfes7pcf/...` –±—É–¥–µ—Ç –∏–∑–≤–ª–µ—á—ë–Ω `cf4dxqbfes7pcf`.

---

## üß© –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ç–æ–∫

–í –∫–æ–º–∞–Ω–¥–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –∫–ª—é—á–∏ –∏–∑ `labels` –≤ —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö:

```bash
# –ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã –≤ YAML
command: "ssh {instance} 'systemctl restart kafka'"

# –ü—Ä–∏ labels: { "instance": "11log-kafka01" }
# –ë—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:
ssh 11log-kafka01 'systemctl restart kafka'
```

–ï—Å–ª–∏ –º–µ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{unknown_label}`), –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ **–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞**, –∏ –≤ –ª–æ–≥–µ –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:

```
WARNING: –ú–µ—Ç–∫–∞ 'unknown_label' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ labels, –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
```

---

## ‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `shell=True` –≤ `subprocess.run` ‚Üí **—Ä–∏—Å–∫—É–µ—Ç shell-–∏–Ω—ä–µ–∫—Ü–∏—è–º–∏**, –µ—Å–ª–∏ –º–µ—Ç–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω—ã.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
  - –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å —Ç–æ–ª—å–∫–æ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–π —Å–µ—Ç–∏.
  - –ù–µ —Ä–∞–∑—Ä–µ—à–∞–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/alert`.
  - –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç–æ–∫ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ö–æ—Å—Ç—ã).
  - –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –æ—Ç–∫–∞–∑ –æ—Ç `shell=True` –∏ –ø–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤—Ä—É—á–Ω—É—é.

---

## üìú –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤:
- –ö–æ–Ω—Å–æ–ª—å (stdout)
- –§–∞–π–ª `alert_executor.log`

–§–æ—Ä–º–∞—Ç:
```
2025-11-17 14:30:22,123 [INFO] –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –∞–ª–µ—Ä—Ç–∞–º–∏
2025-11-17 14:30:22,456 [INFO] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞: echo "–ê–ª–µ—Ä—Ç –Ω–∞ 11log-kafka01..."
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–ª–µ—Ä—Ç —Å –ø–æ–º–æ—â—å—é `curl`:

```bash
curl -X POST http://localhost:9999/alert -H "Content-Type: application/json" -d '
{
  "receiver": "test",
  "status": "firing",
  "alerts": [
    {
      "status": "firing",
      "labels": {
        "alertname": "TestAlert",
        "instance": "test-host",
        "topic": "test"
      },
      "annotations": {},
      "generatorURL": "https://example.com/alerting/grafana/TEST_ALERT_ID/view"
    }
  ]
}'
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `alerts_config.yaml` –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –¥–ª—è `TEST_ALERT_ID`.

---

---

> ‚ú® **–°–æ–≤–µ—Ç**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –∫–∞–∫ –≤–µ–±—Ö—É–∫ –≤ Grafana ‚Üí **Alerting ‚Üí Notification policies ‚Üí Add webhook**.
